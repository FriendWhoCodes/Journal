name: Homepage CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "homepage/**"
      - ".github/workflows/homepage-ci.yml"
  pull_request:
    branches:
      - main
    paths:
      - "homepage/**"
      - ".github/workflows/homepage-ci.yml"

jobs:
  # ============================================
  # STAGE 1: Lint & Type Check
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: homepage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: homepage/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

  # ============================================
  # STAGE 2: Unit & Integration Tests
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: homepage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: homepage/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: homepage/coverage/
          retention-days: 7

  # ============================================
  # STAGE 3: Build Verification
  # ============================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: homepage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: homepage/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d ".next" ]; then
            echo "::error::Build output directory .next not found!"
            exit 1
          fi
          echo "Build verification passed!"

  # ============================================
  # STAGE 4: Deploy to Production
  # Only runs on push to main (not PRs)
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://manofwisdom.co

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Hetzner via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -euo pipefail
            cd /var/www/Journal
            git fetch origin
            git reset --hard origin/main
            cd homepage
            bash scripts/deploy.sh

  # ============================================
  # STAGE 5: Post-Deployment Smoke Tests
  # Verifies production is working after deploy
  # ============================================
  smoke-test:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: homepage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: homepage/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Run smoke tests against production
        run: npm run test:smoke:prod
        env:
          BASE_URL: https://manofwisdom.co

      - name: Verify health endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://manofwisdom.co/api/health)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Health check failed! HTTP $HTTP_CODE"
            exit 1
          fi
          echo "Health check passed!"

      - name: Notify on smoke test failure
        if: failure()
        run: |
          echo "::error::CRITICAL - Production smoke tests failed!"
          echo "::error::Manual verification required at https://manofwisdom.co"

  # ============================================
  # PR Status Check Summary
  # ============================================
  pr-check:
    name: PR Check
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: github.event_name == 'pull_request'
    steps:
      - name: All checks passed
        run: |
          echo "âœ… All CI checks passed!"
          echo "- Lint: Passed"
          echo "- Tests: Passed"
          echo "- Build: Passed"
          echo ""
          echo "This PR is ready for review and merge."
